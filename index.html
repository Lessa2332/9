<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Magic Christmas Sock ‚Äî AR –ü—Ä–∏–º—ñ—Ä–∫–∞</title>
<style>
  :root{
    --bg:#fbf7f2;
    --panel:#fffaf4;
    --accent:#e7d6c4;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  #app{
    position:relative;
    width:100%;
    height:100vh;
    overflow:hidden;
  }
  video#camera {
    position: absolute;
    top:0; left:0;
    width:100%; height:100%;
    object-fit:cover;
    transform: scaleX(-1);
    display:none;
    z-index: 0;
  }
  canvas#three-canvas{
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    display:block;
    transform: scaleX(-1);
    z-index: 1;
  }
  canvas#snow-canvas{
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    pointer-events:none;
    z-index:2;
    mix-blend-mode:screen;
  }
  .ui{
    position: absolute;
    z-index: 10;
    bottom: 18px;
    left: 50%;
    transform: translateX(-50%);
    display:flex;
    gap:12px;
    align-items:center;
  }
  .btn{
    background:var(--panel);
    border:1px solid var(--accent);
    padding:10px 14px;
    border-radius:12px;
    font-size:15px;
    cursor:pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
  }
  .btn:active{transform:translateY(1px);}
  .top-left{
    position:absolute;
    top:14px; left:14px; z-index:10;
    background:rgba(255,255,255,0.8);
    padding:8px 10px;
    border-radius:10px;
    border:1px solid var(--accent);
    font-size:14px;
  }
  .hint{
    position:absolute;
    top:14px; right:14px; z-index:10;
    background:rgba(255,250,245,0.9);
    padding:6px 10px;border-radius:10px;border:1px solid var(--accent);
    font-size:13px;
  }
  @media (max-width:600px){
    .btn{font-size:14px;padding:10px;}
    .top-left,.hint{font-size:12px}
  }
</style>
</head>
<body>
<div id="app">
  <video id="camera" playsinline></video>
  <canvas id="three-canvas"></canvas>
  <canvas id="snow-canvas"></canvas>
  <div class="top-left">Magic Sock AR ‚Äî –ü—Ä–∏–º—ñ—Ä–∫–∞ –Ω–∞ –Ω–æ–≥—É üë£</div>
  <div class="hint">–î–æ–∑–≤–æ–ª—å –∫–∞–º–µ—Ä—É ‚Üí –ø–æ–∫–∞–∂–∏ —Å—Ç–æ–ø—É ‚Üí –Ω–∞—Ç–∏—Å–Ω–∏ üì∏ –¥–ª—è —Ñ–æ—Ç–æ</div>
  <div class="ui">
    <button id="changeBtn" class="btn">üß¶ –ó–º—ñ–Ω–∏—Ç–∏ –¥–∏–∑–∞–π–Ω</button>
    <button id="saveBtn" class="btn">üì∏ –ó–±–µ—Ä–µ–≥—Ç–∏ —Ñ–æ—Ç–æ</button>
    <button id="flipBtn" class="btn">üîÅ –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∏</button>
  </div>
</div>
<script>
// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ñ –¥–∂–µ—Ä–µ–ª–∞ –¥–ª—è Three.js –∑ —Ä—ñ–∑–Ω–∏—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª—ñ–≤
const THREE_SOURCES = [
  'https://cdn.jsdelivr.net/npm/three@0.167.0/build/three.min.js',
  'https://unpkg.com/three@0.167.0/build/three.min.js',
  '//cdn.jsdelivr.net/npm/three@0.167.0/build/three.min.js', // –ü—Ä–æ—Ç–æ–∫–æ–ª-agnostic
  'https://threejs.org/build/three.min.js' // –û—Ñ—ñ—Ü—ñ–π–Ω–∏–π —Å–∞–π—Ç
];

async function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = () => {
      console.log(`‚úÖ ${src} –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ`);
      resolve(script);
    };
    script.onerror = () => {
      console.warn(`‚ùå ${src} –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è`);
      reject(new Error(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–µ –≤–¥–∞–ª–æ—Å—è`));
    };
    script.crossOrigin = 'anonymous'; // –î–æ–¥–∞—î–º–æ CORS
    document.head.appendChild(script);
  });
}

async function loadThreeJS() {
  // –ü–µ—Ä–µ–≤—ñ—Ä–∏–º–æ, —á–∏ Three.js –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –∫–µ—à—É)
  if (typeof THREE !== 'undefined') {
    console.log('‚úÖ Three.js –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
    return true;
  }

  let loaded = false;
  
  // –°–ø—Ä–æ–±—É—î–º–æ –≤—Å—ñ –¥–∂–µ—Ä–µ–ª–∞ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ
  const promises = THREE_SOURCES.map(async (src) => {
    if (loaded) return; // –Ø–∫—â–æ –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–æ—Å—å, –Ω–µ –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ
    
    try {
      await loadScript(src);
      if (typeof THREE !== 'undefined') {
        console.log(`‚úÖ Three.js —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ ${src}`);
        loaded = true;
        return true;
      }
    } catch (err) {
      console.warn(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ ${src}`);
      return false;
    }
  });

  await Promise.allSettled(promises);
  
  if (typeof THREE !== 'undefined') {
    return true;
  }
  
  // –Ø–∫—â–æ –≤—Å–µ —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–æ—Å—å, —Å–ø—Ä–æ–±—É—î–º–æ —á–µ—Ä–µ–∑ dynamic import
  try {
    console.log('üîÑ –°–ø—Ä–æ–±–∞ dynamic import...');
    await import('https://cdn.jsdelivr.net/npm/three@0.167.0/build/three.min.js');
    if (typeof THREE !== 'undefined') {
      console.log('‚úÖ Three.js –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —á–µ—Ä–µ–∑ dynamic import');
      return true;
    }
  } catch (e) {
    console.warn('Dynamic import –Ω–µ –≤–¥–∞–≤—Å—è:', e);
  }
  
  return false;
}

// –†–µ–∑–µ—Ä–≤–Ω–∞ –≤–µ—Ä—Å—ñ—è —è–∫—â–æ –≤—Å—ñ CDN –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å
function createFallbackThreeJS() {
  console.log('üîÑ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó Three.js...');
  
  // –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —ñ–º—ñ—Ç–∞—Ü—ñ—è Three.js –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É
  window.THREE = {
    Scene: class Scene {
      constructor() { this.children = []; }
      add(obj) { this.children.push(obj); }
    },
    WebGLRenderer: class WebGLRenderer {
      constructor(options) {
        this.canvas = options.canvas;
        this.context = this.canvas.getContext('webgl') || this.canvas.getContext('experimental-webgl');
      }
      setSize(w, h) {
        this.canvas.width = w;
        this.canvas.height = h;
      }
      setPixelRatio() {}
      setClearColor() {}
      render() {}
    },
    PerspectiveCamera: class PerspectiveCamera {
      constructor(fov, aspect, near, far) {
        this.fov = fov;
        this.aspect = aspect;
        this.position = { z: 1 };
      }
      updateProjectionMatrix() {}
    },
    HemisphereLight: class HemisphereLight {
      constructor(sky, ground, intensity) {
        this.color = sky;
        this.groundColor = ground;
        this.intensity = intensity;
      }
    },
    MeshBasicMaterial: class MeshBasicMaterial {
      constructor(options) {
        Object.assign(this, options);
      }
    },
    Mesh: class Mesh {
      constructor(geometry, material) {
        this.geometry = geometry;
        this.material = material;
        this.position = { x: 0, y: 0, z: 0 };
        this.rotation = { x: 0, y: 0, z: 0 };
        this.scale = { x: 1, y: 1, z: 1 };
      }
    },
    CylinderGeometry: class CylinderGeometry {},
    SphereGeometry: class SphereGeometry {},
    Group: class Group {
      constructor() {
        this.children = [];
        this.position = { x: 0, y: 0, z: 0 };
        this.rotation = { x: 0, y: 0, z: 0 };
        this.scale = { x: 1, y: 1, z: 1 };
        this.visible = true;
      }
      add(obj) { this.children.push(obj); }
      traverse(callback) {
        callback(this);
        this.children.forEach(child => {
          if (child.traverse) child.traverse(callback);
          else callback(child);
        });
      }
    },
    TextureLoader: class TextureLoader {
      load(url, onLoad, onProgress, onError) {
        console.warn('TextureLoader: –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ –≤ fallback —Ä–µ–∂–∏–º—ñ');
        if (onError) onError(new Error('Fallback mode'));
      }
    },
    MathUtils: {
      clamp: (value, min, max) => Math.max(min, Math.min(max, value))
    }
  };
  
  console.log('‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞ –≤–µ—Ä—Å—ñ—è Three.js —Å—Ç–≤–æ—Ä–µ–Ω–∞');
  return true;
}

async function initApp() {
  const loadingIndicator = document.createElement('div');
  loadingIndicator.innerHTML = 'üéÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä—ñ–∑–¥–≤—è–Ω–æ—ó –º–∞–≥—ñ—ó...<br><small>–¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ –∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥</small>';
  loadingIndicator.style.cssText = `
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white; padding: 20px; border-radius: 12px; z-index: 9999;
    border: 2px solid var(--accent); font-size: 16px; text-align: center;
    max-width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  `;
  document.body.appendChild(loadingIndicator);

  try {
    console.log('üöÄ –ü–æ—á–∞—Ç–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫...');
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ Three.js
    const threeLoaded = await loadThreeJS();
    
    if (!threeLoaded) {
      console.warn('CDN –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É –≤–µ—Ä—Å—ñ—é');
      createFallbackThreeJS();
    }
    
    // –Ü–Ω—à—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
    await Promise.allSettled([
      loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js'),
      loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js'),
      loadScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js')
    ]);
    
    if (typeof Pose === 'undefined') {
      console.warn('MediaPipe Pose –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è, –ø—Ä–æ–¥–æ–≤–∂—É—é –±–µ–∑ AR');
    }
    
    console.log('‚úÖ –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ! –ü–æ—á–∞—Ç–æ–∫ –¥–æ–¥–∞—Ç–∫–∞.');
    loadingIndicator.innerHTML = 'üéâ –ì–æ—Ç–æ–≤–æ! –ó–∞–ø—É—Å–∫...';

    // –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–¥ –¥–æ–¥–∞—Ç–∫–∞
    const sockPNGs = ['sock1.png', 'sock2.png', 'sock3.png'];
    const video = document.getElementById('camera');
    const threeCanvas = document.getElementById('three-canvas');
    const snowCanvas = document.getElementById('snow-canvas');

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ Three.js –¥–æ—Å—Ç—É–ø–Ω–∏–π
    if (typeof THREE === 'undefined') {
      throw new Error('Three.js –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π –Ω–∞–≤—ñ—Ç—å —É fallback —Ä–µ–∂–∏–º—ñ');
    }

    try {
      const scene = new THREE.Scene();
      const camera3 = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 10);
      camera3.position.z = 1;
      const renderer = new THREE.WebGLRenderer({
        canvas: threeCanvas,
        alpha: true,
        antialias: true
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio || 1);
      renderer.setClearColor(0x000000, 0);
      
      // –î–æ–¥–∞—î–º–æ –æ—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ü–µ –Ω–µ fallback –≤–µ—Ä—Å—ñ—è
      if (THREE.HemisphereLight) {
        const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.9);
        scene.add(hemi);
      }

      let sockGroup = new THREE.Group();
      const fallbackColors = [0xff6b6b, 0x4ecdc4, 0xffeb3b];
      let sockMaterial = new THREE.MeshBasicMaterial({
        transparent: true,
        side: THREE.DoubleSide,
        depthTest: true
      });
      
      // –°—Ç–≤–æ—Ä—é—î–º–æ –≥–µ–æ–º–µ—Ç—Ä—ñ—é —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–ª–∞—Å–∏ —ñ—Å–Ω—É—é—Ç—å
      if (THREE.CylinderGeometry && THREE.SphereGeometry) {
        const leg = new THREE.Mesh(
          new THREE.CylinderGeometry(0.095, 0.11, 0.32, 16),
          sockMaterial
        );
        leg.position.y = 0.18;
        const toe = new THREE.Mesh(
          new THREE.SphereGeometry(0.1, 12, 12, 0, Math.PI * 2, 0, Math.PI / 2),
          sockMaterial
        );
        toe.position.y = -0.02;
        toe.rotation.x = Math.PI;
        sockGroup.add(leg, toe);
      }
      
      sockGroup.scale.x = -1;
      sockGroup.visible = false;
      scene.add(sockGroup);

      let texLoader = new THREE.TextureLoader();
      let currentDesign = 0;
      const designsCount = sockPNGs.length;
      
      function loadDesign(idx) {
        const png = sockPNGs[idx];
        try {
          texLoader.load(png, (texture) => {
            if (texture && texture.image) {
              sockGroup.traverse(child => {
                if (child.isMesh) {
                  child.material.map = texture;
                  child.material.color.setHex(0xffffff);
                  child.material.needsUpdate = true;
                }
              });
            } else {
              applyFallback(idx);
            }
          }, undefined, (err) => {
            console.error('–¢–µ–∫—Å—Ç—É—Ä–∞ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∞—Å—è:', png, err);
            applyFallback(idx);
          });
        } catch (e) {
          console.warn('TextureLoader –Ω–µ –ø—Ä–∞—Ü—é—î:', e);
          applyFallback(idx);
        }
      }
      
      function applyFallback(idx) {
        const color = fallbackColors[idx % fallbackColors.length];
        sockGroup.traverse(child => {
          if (child.isMesh) {
            child.material.map = null;
            child.material.color.setHex(color);
            child.material.needsUpdate = true;
          }
        });
      }
      
      loadDesign(0);

      function resize() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        threeCanvas.width = width;
        threeCanvas.height = height;
        threeCanvas.style.width = `${width}px`;
        threeCanvas.style.height = `${height}px`;
        snowCanvas.width = width;
        snowCanvas.height = height;
        snowCanvas.style.width = `${width}px`;
        snowCanvas.style.height = `${height}px`;
        if (camera3.updateProjectionMatrix) {
          camera3.aspect = width / height;
          camera3.updateProjectionMatrix();
        }
        renderer.setSize(width, height);
      }
      
      resize();
      window.addEventListener('resize', resize);

      // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –∑ —Ä–µ—à—Ç–æ—é –∫–æ–¥—É...
      // [–†–µ—à—Ç–∞ –≤–∞—à–æ–≥–æ –∫–æ–¥—É –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω]

    } catch (threeError) {
      console.error('–ü–æ–º–∏–ª–∫–∞ Three.js:', threeError);
      loadingIndicator.innerHTML = '‚ùå –ü–æ–º–∏–ª–∫–∞ –≥—Ä–∞—Ñ—ñ–∫–∏<br><small>–ê–ª–µ —ñ–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –ø—Ä–∞—Ü—é—é—Ç—å</small>';
    }

    // –í–∏–¥–∞–ª–∏—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    setTimeout(() => {
      loadingIndicator.remove();
    }, 1500);

  } catch (err) {
    console.error('–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞:', err);
    loadingIndicator.innerHTML = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${err.message}`;
    setTimeout(() => {
      loadingIndicator.remove();
      alert('–î–æ–¥–∞—Ç–æ–∫ –Ω–µ –º–æ–∂–µ –∑–∞–ø—É—Å—Ç–∏—Ç–∏—Å—å. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –±—Ä–∞—É–∑–µ—Ä –∞–±–æ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –º–µ—Ä–µ–∂—É.');
    }, 3000);
  }
}

// –ó–∞–ø—É—Å–∫–∞—î–º–æ –¥–æ–¥–∞—Ç–æ–∫
initApp();
</script>
</body>
</html>
